# DIY NAS v1

## Table of contents <!-- omit in toc -->

1. [Hardware](#hardware)
1. [Software](#software)
1. [Operational burdens](#operational-burdens)
   1. [Reserved managed port for Proxmox](#reserved-managed-port-for-proxmox)
   1. [Disk passthrough](#disk-passthrough)
   1. [Default permissions on files and directories](#default-permissions-on-files-and-directories)
      1. [Default permissions in SMB shares](#default-permissions-in-smb-shares)
1. [Further readings](#further-readings)
1. [Sources](#sources)

## Hardware

| Component    | Choice                                                                  | Price                                                              |
| ------------ | ----------------------------------------------------------------------- | ------------------------------------------------------------------ |
| Case         | [Fractal Design Node 304]                                               | [€99][amazon  fractal design node 304]                             |
| CPU          | [Intel Celeron N5105]                                                   | Included in the motherboard                                        |
| Hard disks   | [Seagate IronWolf ST4000VN008 4TB]                                      | €556,00 (4x [€139,00][coolblue  seagate ironwolf st4000vn008 4tb]) |
| Motherboard  | Mini ITX NAS motherboard with Intel N5105 and I225                      | [€175,28][amazon  nas motherboard]                                 |
| Power supply | [Corsair RM850e] fully modular                                          | [€117,90][amazon  corsair rm850e 2023]                             |
| RAM          | [Crucial CT2K16G4SFRA32A] 32GB kit (2x16GB)                             | [€67,95][amazon  crucial ct2k16g4sfra32a]                          |
| SATA cables  | Cable Matters 6.0Gbps SATA III cable with 90 degrees angle, black, 45cm | €11,98 (2x [€5,99][amazon  cable matters sata cables])             |

## Software

[Proxmox] on bare metal, running [TrueNAS Core] as VM.

## Operational burdens

### Reserved managed port for Proxmox

One NIC is used by Proxmox as _management port_.<br/>
This one is given a fixed IP address and bridged from inside the system.

### Disk passthrough

To allow for disk suspension and SMART checks from the VM, Proxmox needs to **directly** attach the disks to it:

```sh
$ lsblk -do 'NAME,SIZE,TYPE,MODEL,SERIAL' -I '8'
NAME  SIZE TYPE MODEL              SERIAL
sda   3.6T disk ST4000VN008-2DR166 ZGY9WA2F
sdb   3.6T disk ST4000VN008-2DR166 ZGY9WDD5
sdc   3.6T disk ST4000VN008-2DR166 ZGY9WL4Z
sdd   3.6T disk ST4000VN008-2DR166 ZGY9W66G

$ qm set 100 -sata0 /dev/disk/by-id/ata-ST4000VN008-2DR166_ZGY9WA2F
$ qm set 100 -sata1 /dev/disk/by-id/ata-ST4000VN008-2DR166_ZGY9WDD5
$ qm set 100 -sata2 /dev/disk/by-id/ata-ST4000VN008-2DR166_ZGY9WL4Z
$ qm set 100 -sata3 /dev/disk/by-id/ata-ST4000VN008-2DR166_ZGY9W66G
```

### Default permissions on files and directories

Suppose you want a shared dataset to set the default permissions of newly created files and directories to `0664` and `0775` respectively.

The best way to achieve this would be to set up the dataset's ACLs accordingly:

| Who       | ACL Type | Permissions Type | Permissions                                                                                                                                                                                   | Flags Type | Flags             | Translated `getfacl` Tags                | Resulting Unix Permissions |
| --------- | -------- | ---------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------- | ----------------- | ---------------------------------------- | -------------------------- |
| owner@    | Allow    | Advanced         | Read Data, Write Data, Append Data<br/>Read Named Attributes, Write Named Attributes<br/>Read Attributes, Write Attributes<br/>Delete<br/>Read ACL, Write ACL<br/>Write Owner<br/>Synchronize | Advanced   | File Inherit      | `   owner@:rw-p-daARWcCos:f------:allow` | `-rw-------`               |
| owner@    | Allow    | Basic            | Full Control                                                                                                                                                                                  | Advanced   | Directory Inherit | `   owner@:rwxpDdaARWcCos:-d-----:allow` | `drwx------`               |
| group@    | Allow    | Advanced         | Read Data, Write Data, Append Data<br/>Read Named Attributes, Write Named Attributes<br/>Read Attributes, Write Attributes<br/>Delete<br/>Read ACL, Write ACL<br/>Write Owner<br/>Synchronize | Advanced   | File Inherit      | `   group@:rw-p-daARWcCos:f------:allow` | `----rw----`               |
| group@    | Allow    | Basic            | Full Control                                                                                                                                                                                  | Advanced   | Directory Inherit | `   group@:rwxpDdaARWcCos:-d-----:allow` | `d---rwx---`               |
| everyone@ | Allow    | Advanced         | Read Data<br/>Read Named Attributes<br/>Read Attributes<br/>Read ACL                                                                                                                          | Advanced   | File Inherit      | `everyone@:r-----a-R-c---:f------:allow` | `-------r--`               |
| everyone@ | Allow    | Advanced         | Read Data<br/>Read Named Attributes<br/>Execute<br/>Read Attributes<br/>Read ACL                                                                                                              | Advanced   | Directory Inherit | `everyone@:r-x---a-R-c---:-d-----:allow` | `d------r-x`               |

#### Default permissions in SMB shares

A simpler but arguably worse way to achieve a similar result **only for SMB shares** is by using the _mask_ `smb.conf` additional parameters in the share definition:

```txt
create mask = 664
directory mask = 775
```

If a dataset has no ACLs set and you create a SMB share for it, you are asked to create them for its filesystem.<br/>
You can cancel at this point and go for the additional parameters instead.

## Further readings

- [TrueNAS core]

## Sources

All the references in the [further readings] section, plus the following:

- [The Perfect Home Server 2023]
- [How to run TrueNAS on Proxmox?]

<!--
  References
  -->

<!-- Upstream -->
[corsair rm850e]: https://www.corsair.com/ww/en/p/psu/cp-9020249-ww/rme-series-rm850e-fully-modular-low-noise-atx-power-supply-cp-9020249-ww
[crucial ct2k16g4sfra32a]: https://eu.crucial.com/memory/ddr4/ct2k16g4sfra32a
[fractal design node 304]: https://www.fractal-design.com/products/cases/node/node-304/black/
[how to run truenas on proxmox?]: https://www.youtube.com/watch?v=M3pKprTdNqQ
[intel celeron n5105]: https://www.intel.com/content/www/us/en/products/sku/212328/intel-celeron-processor-n5105-4m-cache-up-to-2-90-ghz/specifications.html
[seagate ironwolf st4000vn008 4tb]: https://www.seagate.com/products/nas-drives/ironwolf-hard-drive/
[the perfect home server 2023]: https://www.youtube.com/watch?v=vjDoQA4C22c
[truenas core]: https://www.truenas.com/truenas-core/

<!-- In-article sections -->
[further readings]: #further-readings

<!-- Knowledge base -->
[proxmox]: ../proxmox.md

<!-- Others -->
[amazon  cable matters sata cables]: https://www.amazon.nl/dp/B018Y2LEBE/
[amazon  corsair rm850e 2023]: https://www.amazon.nl/dp/B0BVL17341/
[amazon  crucial ct2k16g4sfra32a]: https://www.amazon.nl/dp/B08C4X9VR5/
[amazon  fractal design node 304]: https://www.amazon.nl/dp/B009PIEMUC/
[amazon  nas motherboard]: https://www.amazon.nl/dp/B0BYVNZDGS/
[coolblue  seagate ironwolf st4000vn008 4tb]: https://www.coolblue.nl/en/product/750006/seagate-ironwolf-st4000vn008-4tb.html
